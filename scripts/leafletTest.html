<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Leaflet Test</title>
  <script src="/community_districts.geojson"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script type="text/javascript" src="timeLineBrush.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
  integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
   integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
   crossorigin=""></script>
   <style>
     #map{
       left: 22px;//mudanças aqui implicam em mudar a posicao inicial do timeLineBrush para deixar alinhado
       height:500px;
       width:50%;
     }
     input{
       position:absolute;
       left: 800px;
     }
     #mapButton0{
       top: 100px;
     }
     #mapButton1{
       top: 150px;
     }
     #mapButton2{
       top: 200px;
     }
     #mapButton3{
       top: 250px;
     }
     #mapButton4{
       top: 300px;
     }
     #mapButton5{
       top: 350px;
     }
     label{
       position:absolute;
       left: 825px;
     }
     #labelMapa0{
       top: 102px;
     }
     #labelMapa1{
       top: 152px;
     }
     #labelMapa2{
       top: 202px;
     }
     #labelMapa3{
       top: 252px;
     }
     #labelMapa4{
       top: 302px;
     }
     #labelMapa5{
       top: 352px;
     }
     .brush .overlay{
       cursor: default;
     }
   </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var myDispatcher = d3.dispatch("selectionChanged");

    myDispatcher.on("selectionChanged", function(){
      for(var i=0;i<markers.length;i++){
        if(inInterval(this.dates[0],this.dates[1],markers[i].options.date)){
          markers[i].addTo(mymap);
        }
        else markers[i].removeFrom(mymap);
      }
    });
    var k = new TimeLineBrush("t1",10,0,1);
    k.dispatcher=myDispatcher;

    var mymap = L.map('map').setView([40.730610, -73.935242], 12);
    mymap.options.minZoom = 9;

    mymap.on('zoomend',function(){
        var Z = mymap.getZoom();
        console.log(Z);
        if(Z<=13){
          markers.forEach(function(d){
            d.setRadius(240/Z);
          })
        }
        else if(Z<17){
          markers.forEach(function(d){
            d.setRadius(120/Z);
          })
        }
        else{
          markers.forEach(function(d){
            d.setRadius(60/Z);
          })
        }

    })
    var markers = [];

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYnZjbCIsImEiOiJjajhjOTRob2EwN2dyMndwbXd2cDJyZnRnIn0.7ZyvE-5-N36TRT56T-Us8g', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox.streets',
      accessToken: 'your.mapbox.access.token'
    }).addTo(mymap);

    $.getJSON("community_districts.geojson",function(data){
    // add GeoJSON layer to the map once the file is loaded
        L.geoJSON(data).addTo(mymap);
    });

    var parseDate = d3.timeParse("%m/%d/%Y");
    function inInterval(a,b,c){
      var d0 = a;
      var df = b;
      var d = c;
      if(d-d0>=0 && df-d>=0)return true;
      else return false;
    }

    var popup = L.popup();

    function addMarker(obj){
      var circle = L.circle([obj.Latitude,obj.Longitude], {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 1,
          radius: 80,
          text:obj.OFNS_DESC,
          area:obj.BORO_NM,
          date:parseDate(obj.CMPLNT_FR_DT)
      })
      .addTo(mymap)
      .on('mouseover',function(){
        popup
        .setLatLng(this._latlng)
        .setContent(this.options.text)
        .openOn(mymap);
      })
      .on('mouseout',function(){
        popup.remove();
      });

      markers.push(circle);
    }



    function updateMap(){
      str = document.querySelector('input[name="Maps"]:checked').value;
      for (var i = 0; i < markers.length; i++) {
        if(str=="ALL" && markers[i]._map==null){
          markers[i].addTo(mymap);
        }
        else if(str!="ALL" && markers[i]._map!=null && markers[i].options.area!=str){
          markers[i].removeFrom(mymap);
        }
        else if(str!="ALL" && markers[i]._map==null && markers[i].options.area==str) {
          markers[i].addTo(mymap);
        }
      }
    }
    d3.csv("NYPD_Complaint_Data_Historic_Sample.csv",function(data){
      data.forEach(function(d){
        addMarker(d)
      })
    })
  </script>

  <input id="mapButton0" type="radio" name="Maps" value="ALL" autocomplete="off" onclick="updateMap()">
  <input id="mapButton1" type="radio" name="Maps" value="QUEENS" autocomplete="off" onclick="updateMap()">
  <input id="mapButton2" type="radio" name="Maps" value="BRONX" autocomplete="off" onclick="updateMap()">
  <input id="mapButton3" type="radio" name="Maps" value="BROOKLYN" autocomplete="off" onclick="updateMap()">
  <input id="mapButton4" type="radio" name="Maps" value="STATEN ISLAND" autocomplete="off" onclick="updateMap()">
  <input id="mapButton5" type="radio" name="Maps" value="MANHATTAN" autocomplete="off" onclick="updateMap()">

  <label id="labelMapa0">All</label>
  <label id="labelMapa1">Queens</label>
  <label id="labelMapa2">Bronx</label>
  <label id="labelMapa3">Brooklyn</label>
  <label id="labelMapa4">Staten Island</label>
  <label id="labelMapa5">Manhattan</label>
</body>
</html>
