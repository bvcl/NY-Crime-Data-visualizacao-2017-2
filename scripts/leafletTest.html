<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Leaflet Test</title>
  <script src="/community_districts.geojson"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="crossfilter.js"></script>
  <script type="text/javascript" src="timeLineBrush.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
  integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
   integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
   crossorigin=""></script>
   <style>
     #map{
       left: 22px;
       height:500px;
       width:50%;
     }
     input{
       position:absolute;
       left: 800px;
     }
     #mapButton0{
       top: 100px;
     }
     #mapButton1{
       top: 150px;
     }
     #mapButton2{
       top: 200px;
     }
     #mapButton3{
       top: 250px;
     }
     #mapButton4{
       top: 300px;
     }
     #mapButton5{
       top: 350px;
     }
     #remGeoButton{
       top: 400px;
     }
     label{
       position:absolute;
       left: 825px;
     }
     #labelMapa0{
       top: 102px;
     }
     #labelMapa1{
       top: 152px;
     }
     #labelMapa2{
       top: 202px;
     }
     #labelMapa3{
       top: 252px;
     }
     #labelMapa4{
       top: 302px;
     }
     #labelMapa5{
       top: 352px;
     }
     #policeDepts{
       top: 403px;
     }
     .brush .overlay{
       cursor: default;
     }
   </style>
</head>
<body>
  <div id="map"></div>
  <input id="mapButton0" class="filterButton" type="radio" name="Maps" value="ALL" autocomplete="off" onclick="forceBrush()" checked>
  <input id="mapButton1" class="filterButton" type="radio" name="Maps" value="QUEENS" autocomplete="off" onclick="forceBrush()">
  <input id="mapButton2" class="filterButton" type="radio" name="Maps" value="BRONX" autocomplete="off" onclick="forceBrush()">
  <input id="mapButton3" class="filterButton" type="radio" name="Maps" value="BROOKLYN" autocomplete="off" onclick="forceBrush()">
  <input id="mapButton4" class="filterButton" type="radio" name="Maps" value="STATEN ISLAND" autocomplete="off" onclick="forceBrush()">
  <input id="mapButton5" class="filterButton" type="radio" name="Maps" value="MANHATTAN" autocomplete="off" onclick="forceBrush()">

  <input id="remGeoButton" type="checkbox" autocomplete="off" onclick="removeGeoJson()">


  <script>
    var myDispatcher = d3.dispatch("selectionChanged","nullSelection");
    myDispatcher.on("selectionChanged", function(){
      str = document.querySelector('input[name="Maps"]:checked').value;
      for(var i=0;i<markers.length;i++){
        if(inInterval(this.dates[0],this.dates[1],markers[i].options.date) && (str=="ALL" || markers[i].options.area==str)){
          markers[i].addTo(mymap);
        }
        else markers[i].removeFrom(mymap);
      }
    });
    myDispatcher.on("nullSelection", function(){
      document.getElementById('mapButton0').checked=true;
      for(var i=0;i<markers.length;i++){
        markers[i].addTo(mymap);
      }
    });

    var k = new TimeLineBrush("t1",10,0,1,[]);
    k.dispatcher=myDispatcher;
    var mymap = L.map('map').setView([40.730610, -73.935242], 12);
    mymap.options.minZoom = 9;

    mymap.on('zoomend',function(){
        var Z = mymap.getZoom();
        if(Z<=13){
          markers.forEach(function(d){
            d.setRadius(240/Z);
          })
        }
        else if(Z<17){
          markers.forEach(function(d){
            d.setRadius(120/Z);
          })
        }
        else{
          markers.forEach(function(d){
            d.setRadius(60/Z);
          })
        }

    })

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYnZjbCIsImEiOiJjajhjOTRob2EwN2dyMndwbXd2cDJyZnRnIn0.7ZyvE-5-N36TRT56T-Us8g', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox.streets',
      accessToken: 'your.mapbox.access.token'
    }).addTo(mymap);

    var geoJson;
    var gjData
    $.getJSON("Police Precincts.geojson",function(data){
    // add GeoJSON layer to the map once the file is loaded
        geoJson=L.geoJSON(data);
        data.features.forEach(function(d){
          d.properties.occurrences=0;
        })
        gjData=data;
        //geoJson.addTo(mymap);
    });

    var flag=true;

    function removeGeoJson(){
      var color2 = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, 32]).clamp(true);
      if(flag){
        console.log(countByPoliceDept);
        gjData.features.forEach(function(d){
          d.properties.occurrences=countByPoliceDept[d.properties.precinct-1];
        })

        geoJson=L.geoJSON(gjData,{
          style: function(d){
            return {fillColor: color2(d.properties.occurrences),
                    color: color2(d.properties.occurrences),
                    fillOpacity: 0.4,
                    opacity: 0.4};
          },
          onEachFeature:function(d,layer){
            layer.on("mouseover",function(){
              createPopUp(layer.getBounds().getCenter(),d.properties.occurrences)
            })
            layer.on("mouseout",function(){
              popup.remove();
            })
          }
        });
        flag=false;
      }
      //max = 32 min = 0
      if(!document.getElementById('remGeoButton').checked){
        geoJson.removeFrom(mymap);
        forceBrush();
      }
      else{
       geoJson.addTo(mymap);
       markers.forEach(function(d){
         d.removeFrom(mymap);
       })
      }
    }
    var parseDate = d3.timeParse("%m/%d/%Y");
    function inInterval(a,b,c){
      var d0 = a;
      var df = b;
      var d = c;
      if(d-d0>=0 && df-d>=0)return true;
      else return false;
    }

    var popup = L.popup();
    function createPopUp(pos,text) {
      popup
      .setLatLng(pos)
      .setContent(text.toString())
      .openOn(mymap);
    }

    var markers = [];

    function addMarker(obj){
      var circle = L.circle([obj.Latitude,obj.Longitude], {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 1,
          radius: 80,
          text:obj.OFNS_DESC,
          area:obj.BORO_NM,
          date:parseDate(obj.CMPLNT_FR_DT)
      })
      .addTo(mymap)
      .on('mouseover',function(){
        createPopUp(this._latlng,this.options.text)
      })
      .on('mouseout',function(){
        popup.remove();
      });

      markers.push(circle);
    }

    function forceBrush(){
      k.forceBrush();
    }

    var countByPoliceDept=[];
    var allDates=[];
    var occurrencesByDate=[]
    var ano,mes,dia;
    for(p=2000;p<2017;p++){
      ano=p.toString();
      for(j=1;j<13;j++){
        if(j<10)mes="0"+j;
        else mes=j.toString();
        for(i=1;i<32;i++){
          if(i<10)dia="0"+i;
          else dia=i.toString()
          finalDate = mes+"/"+dia+"/"+ano;
          allDates.push(finalDate)
          occurrencesByDate.push(0);
        }
      }
    }

    for(i=0;i<123;i++)countByPoliceDept.push(0);
    d3.csv("NYPD_Complaint_Data_Historic_Sample.csv",function(data){
      console.log(data);
      // var crimeNYC = crossfilter(data);
      // var crimeByPDPT = crimeNYC.dimension(function(d) { return Number(d.ADDR_PCT_CD); });
      // var crimeGroupsByPDPT = crimeByPDPT.group();
      // console.log(crimeGroupsByPDPT.all());
      data.forEach(function(d,i){
        addMarker(d);
        countByPoliceDept[Number(d.ADDR_PCT_CD)-1]+=1;
        occurrencesByDate[allDates.indexOf(d.CMPLNT_FR_DT)]+=1
      })
      occurrencesByDate = allDates.map(function(e, i) {
        return [parseDate(e), occurrencesByDate[i]];
      });
      k.updateLineChart(occurrencesByDate);
    })
  </script>
  <label id="labelMapa0">All</label>
  <label id="labelMapa1">Queens</label>
  <label id="labelMapa2">Bronx</label>
  <label id="labelMapa3">Brooklyn</label>
  <label id="labelMapa4">Staten Island</label>
  <label id="labelMapa5">Manhattan</label>

  <label id="policeDepts">Show Police Depts.</label>
</body>
</html>
