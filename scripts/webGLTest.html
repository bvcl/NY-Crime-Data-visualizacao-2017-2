<!doctype html>
<html>
<head>
    <title>NY Crimes Visualization</title>
    <meta charset="utf-8">

    <style>
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            height: 100%;
        }

        #map {
            position: static;
            left: 22px;
            height:500px;
            width:50%;
        }
        #tlBrush {
            position: static;
            left: 22px;
            top:510px;
        }
        #bchart1 {
            position: absolute;
            left: 670px;
            top:60px;
        }
        #bchart2 {
            position: absolute;
            left: 670px;
            top:200px;
        }
        #bchart3 {
            position: absolute;
            left: 670px;
            top:340px;
        }
        #heatmap {
            position: absolute;
            left: 100px;
            top:600px;
        }
        input{
          position:absolute;
          left: 800px;
        }
        #mapButton0{
          top: 100px;
        }
        #mapButton1{
          top: 150px;
        }
        #mapButton2{
          top: 200px;
        }
        #mapButton3{
          top: 250px;
        }
        #mapButton4{
          top: 300px;
        }
        #mapButton5{
          top: 350px;
        }
        #remGeoButton{
          top: 550px;
        }
        label{
          position:absolute;
          left: 825px;
        }
        #labelMapa0{
          top: 102px;
        }
        #labelMapa1{
          top: 152px;
        }
        #labelMapa2{
          top: 202px;
        }
        #labelMapa3{
          top: 252px;
        }
        #labelMapa4{
          top: 302px;
        }
        #labelMapa5{
          top: 352px;
        }
        #policeDepts{
          top: 553px;
        }
        .brush .overlay{
          cursor: default;
        }
        .axisHeatTable path,
        .axisHeatTable line {
          fill: none;
          stroke: black;
          shape-rendering: crispEdges;
        }

        .axisHeatTable text {
            font-family: sans-serif;
            font-size: 11px;
        }
    </style>
    <!-- vertex shader -->
    <script id="vshader" type="x-shader/x-vertex">
        uniform mat4 u_matrix;
        attribute vec4 a_vertex;
        attribute float a_pointSize;
        attribute vec4 a_color;
        varying vec4 v_color;

        void main() {
        // Set the size of the point
        gl_PointSize =  a_pointSize;

        // multiply each vertex by a matrix.
        gl_Position = u_matrix * a_vertex;


        // pass the color to the fragment shader
        v_color = a_color;
        }
    </script>
    <!-- fragment shader -->



    <script id="fshader" type="x-shader/x-fragment">
        precision mediump float;
        varying vec4 v_color;
        uniform int u_colorFlag;

        void main() {

        float border = 0.05;
        float radius = 0.5;
        vec4 color0 = vec4(0.0, 0.0, 0.0, 0.0);
        vec4 color1 = vec4(v_color[0], v_color[1], v_color[2], 1.0);

        vec2 m = gl_PointCoord.xy - vec2(0.5, 0.5);
        float dist = radius - sqrt(m.x * m.x + m.y * m.y);

        float t = 0.0;
        if (dist > border)
        t = 1.0;
        else if (dist > 0.0)
        t = dist / border;

        // float centerDist = length(gl_PointCoord - 0.5);
        // works for overlapping circles if blending is enabled



        gl_FragColor = mix(color0, color1, t);
        //gl_FragColor=vec4(1.0,0.0,0.0,1.0);




        /*
        // -- another way for circle
        float centerDist = length(gl_PointCoord - 0.5);
        float radius = 0.5;
        // works for overlapping circles if blending is enabled
        gl_FragColor = vec4(v_color[0], v_color[1], v_color[2], 0.2 * step(centerDist, radius));
        */

        /*
        // simple circles
        float d = distance (gl_PointCoord, vec2(0.5,0.5));
        if (d < 0.5 ){
        gl_FragColor =vec4(v_color[0], v_color[1], v_color[2], 0.2);
        }
        else{
        discard;
        }
        */

        // -- squares
        //gl_FragColor = v_color;
        //gl_FragColor =vec4(v_color[0], v_color[1], v_color[2], 0.2); // v_color;

        }

    </script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script type="text/javascript" src="timeLineBrush.js"></script>
    <script type="text/javascript" src="linkedBarChart.js"></script>
    <script type="text/javascript" src="heatMapTable.js"></script>
    <script src="crossfilter.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

</head>
<body>
    <div id="map"></div>
    <div id="tlBrush"></div>
    <div id="bchart1"></div>
    <div id="bchart2"></div>
    <div id="bchart3"></div>
    <div id="heatmap"></div>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="http://www.sumbera.com/gist/js/leaflet/canvas/L.CanvasOverlay.js"></script>

    <!--
    <input id="mapButton0" class="filterButton" type="radio" name="Maps" value="ALL" autocomplete="off" onclick="forceSelection()" checked>
    <input id="mapButton1" class="filterButton" type="radio" name="Maps" value="QUEENS" autocomplete="off" onclick="forceSelection()">
    <input id="mapButton2" class="filterButton" type="radio" name="Maps" value="BRONX" autocomplete="off" onclick="forceSelection()">
    <input id="mapButton3" class="filterButton" type="radio" name="Maps" value="BROOKLYN" autocomplete="off" onclick="forceSelection()">
    <input id="mapButton4" class="filterButton" type="radio" name="Maps" value="STATEN ISLAND" autocomplete="off" onclick="forceSelection()">
    <input id="mapButton5" class="filterButton" type="radio" name="Maps" value="MANHATTAN" autocomplete="off" onclick="forceSelection()">
    -->
    <input id="remGeoButton" type="checkbox" autocomplete="off" onclick="removeGeoJson()">

    <script>
        var myDispatcher = d3.dispatch("selectionChanged","nullSelection");
        var myDispatcher2 = d3.dispatch("filterChanged");
        var parseDate = d3.timeParse("%m/%d/%Y");
        var limitDate1 = parseDate("01/01/2000");
        var limitDate2 = parseDate("12/31/2016");
        myDispatcher.on("selectionChanged", function(){
          //if(document.getElementById('remGeoButton').checked)return;
          //para alterar a mudanca de choropleth com o brush remover o comentario acima,
          //comentar as linhas crimeByDate.filter... e if(document.getElementById)....
          //e tirar o else da linha else standardOperation(intersection).....

          limitDate1=this.dates[0];
          limitDate2=this.dates[1];
          arrayFilterPlaces=[];
          arrayFilterWeekDays=[];
          arrayFilterTypes=[];
          currentFilters.forEach(function(d){
            ptype = paramType(d);
            if(ptype=="number"){
              arrayFilterWeekDays.push(indexesForWeekDays[d]);
            }
            else if(ptype=="place"){
              arrayFilterPlaces.push(hashFuncPlace(d))
            }
            else{
              arrayFilterTypes.push(indexesForCrimeTypes[getCrimeCode(d)])
            }
          })
          if(arrayFilterWeekDays.length>0)arrayFilterWeekDays = [].concat.apply([], arrayFilterWeekDays.slice(0, arrayFilterWeekDays.length));
          else arrayFilterWeekDays = [].concat.apply([], indexesForWeekDays.slice(0, indexesForWeekDays.length));
          if(arrayFilterPlaces.length>0)arrayFilterPlaces = [].concat.apply([], arrayFilterPlaces.slice(0, arrayFilterPlaces.length))
          else arrayFilterPlaces = [].concat.apply([], indexesForPlaces.slice(0, indexesForPlaces.length))
          if(arrayFilterTypes.length>0)arrayFilterTypes = [].concat.apply([], arrayFilterTypes.slice(0, arrayFilterTypes.length))
          else arrayFilterTypes = [].concat.apply([], indexesForCrimeTypes.slice(0, indexesForCrimeTypes.length))

          var that = this;
          crimeByDate.filter(function(d,i){return inInterval(that.dates[0],that.dates[1],d)})
          barsToPass1=[];
          barsToPass2=[];
          barsToPass3=[];
          d3.selectAll(".bar1")._groups[0].forEach(function(d,i){
            if(i<7){
              barsToPass1.push(d)
            }
            else if(i<12){
              barsToPass2.push(d)
            }
            else barsToPass3.push(d)
          });
          bc1.updatePlot(crimeByDayOfWeek,barsToPass1);
          bc2.updatePlot(crimeByPlace,barsToPass2)
          bc3.updatePlot(crimeByType,barsToPass3)
          var locationFilter;
          if(comDiscFilter.length>0)locationFilter=indexesForComDisc[getCommunityCode(comDiscFilter[0])]
          else locationFilter=[].concat.apply([], indexesForComDisc.slice(0, indexesForComDisc.length));
          if(document.getElementById('remGeoButton').checked){removeGeoJson();}
          else standardOperation(manyIntersections([hashFuncDate(that.dates[0],that.dates[1]),arrayFilterPlaces,arrayFilterWeekDays,arrayFilterTypes,locationFilter]))
        });
        myDispatcher.on("nullSelection", function(){
          if(document.getElementById('remGeoButton').checked)return;
          document.getElementById('mapButton0').checked=true;
          standardOperation(hashFuncPlace("ALL"));
        });
        var currentFilters=[];
        var placeFilters=[];
        var weekDaysFilters=[];
        var typeFilters = [];
        var filteredBChart1=false;
        var filteredBChart2=false;
        var filteredBChart3=false;
        myDispatcher2.on("filterChanged",function(){
          currentFilters=[];
          var that = this;
          if(this.id==2){
            weekDaysFilters=[];
            this.filters.forEach(function(d){
              weekDaysFilters.push(d);
            })
            currentFilters=placeFilters.concat(weekDaysFilters).concat(typeFilters)
            if(this.filters.length>0){
              filteredBChart1=true;
              crimeByDayOfWeek.filter(function(d){return that.filters.indexOf(d)>-1})
            }
            else{
              filteredBChart1=false;
              crimeByDayOfWeek.filterAll();
            }
            updateByWeekDay(that.filters);
          }
          else if(this.id==3){
            placeFilters=[]
            this.filters.forEach(function(d){
              placeFilters.push(d);
            })
            currentFilters=placeFilters.concat(weekDaysFilters).concat(typeFilters)
            if(this.filters.length>0){
              filteredBChart2=true;
              crimeByPlace.filter(function(d){return that.filters.indexOf(d)>-1})
            }
            else{
              filteredBChart2=false;
              crimeByPlace.filterAll();
            }
            forceSelection(that.filters);
          }
          else if(this.id==4){
            typeFilters=[]
            this.filters.forEach(function(d){
              typeFilters.push(d);
            })
            currentFilters=placeFilters.concat(weekDaysFilters).concat(typeFilters)
            if(this.filters.length>0){
              filteredBChart3=true;
              crimeByType.filter(function(d){return that.filters.indexOf(d)>-1})
            }
            else{
              filteredBChart3=false;
              crimeByType.filterAll();
            }
            updateByCrimeType(that.filters);
          }
          linkedBarChartArray.forEach(function(d){
            if(that.id!=d.id){
              if(d.id==2 && filteredBChart1==false)d.updatePlot(crimeByDayOfWeek)
              else if(d.id==3 && filteredBChart2==false) d.updatePlot(crimeByPlace)
              else if(d.id==4 && filteredBChart3==false) d.updatePlot(crimeByType)
            }
          })
        })
        linkedBarChartArray = [];
        var bc1 = new LinkedBarChart(2,[],"#bchart1");//crimeByDayOfWeek
        var bc2 = new LinkedBarChart(3,[],"#bchart2")//crimeByPlace
        var bc3 = new LinkedBarChart(4,[],"#bchart3")//crimeByType
        linkedBarChartArray.push(bc1,bc2,bc3)
        var k = new TimeLineBrush("t1",10,0,1,[]);
        k.dispatcher=myDispatcher;
        bc1.dispatcher=myDispatcher2;
        bc2.dispatcher=myDispatcher2;
        bc3.dispatcher=myDispatcher2;
        var leafletMap = L.map('map').setView([40.730610, -73.935242], 12);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYnZjbCIsImEiOiJjajhjOTRob2EwN2dyMndwbXd2cDJyZnRnIn0.7ZyvE-5-N36TRT56T-Us8g', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox.streets',
          accessToken: 'your.mapbox.access.token'
        }).addTo(leafletMap);
        var glLayer = L.canvasOverlay()
                       .drawing(drawingOnCanvas)
                       .addTo(leafletMap);
        oldL = L.noConflict();
        console.log(oldL.version);
        console.log(L.version);

        var geoJson;
        var gjData
        $.getJSON("community_districts.geojson",function(data){
        // add GeoJSON layer to the map once the file is loaded
            geoJson=oldL.geoJson(data);
            data.features.forEach(function(d){
              d.properties.occurrences=0;
            })
            gjData=data;
          //   numArr=[]
          // gjData.features.forEach(function(d){numArr.push(d.properties.BoroCD)});
          // numArr=numArr.sort();
          // offset=0;
          // for(i=0;i<numArr.length;i++){
          //   if(numArr[i]%100>18){
          //     offset+=1;
          //     continue;
          //   }
          //   if(i>0)console.log("else if(param=="+numArr[i]+")return "+(i-offset));
          //   else console.log("if(param=="+numArr[i]+")return "+(i-offset));
          // }
            //geoJson.addTo(mymap);
        });

        var color2;
        var selected=false;
        var previousClicked
        var comDiscFilter=[];
        function removeGeoJson(){
          minDomain = crimeGroupsByComDist.top(Infinity).reverse().filter(function(d){return d.value!=0})[0].value-10;
          if(minDomain<0)minDomain=0;
          color2=d3.scaleSequential(d3.interpolateYlOrRd).domain([minDomain, crimeGroupsByComDist.top(1)[0].value]).clamp(true);
          gjData.features.forEach(function(d){
            var objAux = crimeGroupsByComDist.all().find((item) => Number(item.key) === Number(d.properties.BoroCD));
            if(typeof(objAux)!=="undefined")d.properties.occurrences=objAux.value;
            else d.properties.occurrences=0;
          })
          if(!document.getElementById('remGeoButton').checked){
            leafletMap.closePopup();
            leafletMap.on('mousemove',function(e) {
              obj = LatLongToPixelXY(e.latlng.lat,e.latlng.lng)
              if(popup._isOpen){
                obj2 = LatLongToPixelXY(popup._latlng.lat,popup._latlng.lng)
                if(aprxEqual(obj.x,obj.y,obj2.x,obj2.y,0.002))return;
                else leafletMap.closePopup();
              }
              else{
                for(i=0;i<vertArray.length;i+=5){
                  if(aprxEqual(vertArray[i],vertArray[i+1],obj.x,obj.y,0.0003)){
                    createPopUp(e.latlng,crimeTypeCurrVert[(i/5)])
                    break;
                  }
                }
              }
            });
            geoJson.clearLayers();
            forceBrush();
          }
          else{
            geoJson.clearLayers();
            leafletMap.off('mousemove');
            featuresToPlot=[]
            gjData.features.forEach(function(d){
              if(d.properties.occurrences!=0)featuresToPlot.push(d);
            });
            newgjData = {type:"FeatureCollection",features:featuresToPlot}
            geoJson=oldL.geoJson(newgjData,{
              style: function(d){
                return {fillColor: color2(d.properties.occurrences),
                        color: color2(d.properties.occurrences),
                        fillOpacity: 0.4,
                        opacity: 0.4};
              },
              onEachFeature:function(d,layer){
                layer.on("mouseover",function(e){
                  obj = LatLongToPixelXY(e.latlng.lat,e.latlng.lng)
                  createPopUp(layer.getBounds().getCenter(),d.properties.occurrences)
                })
                layer.on("mouseout",function(){
                  //leafletMap.closePopup();
                })
                layer.on("click",function(e){
                  if(selected==true && previousClicked==layer.feature.properties.BoroCD){
                    selected=false;
                    comDiscFilter.pop();
                    previousClicked="null";
                    crimeByComDist2.filterAll();
                    k.updateLineChart(crimeGroupsByDate.all())
                    forceBrush();
                    leafletMap.setView([40.730610, -73.935242], 12);
                  }
                  else{
                    selected=true;
                    auxThis=this;
                    comDiscFilter.pop();
                    comDiscFilter.push(auxThis.feature.properties.BoroCD)
                    previousClicked=auxThis.feature.properties.BoroCD;
                    crimeByComDist2.filter(function(o){return Number(o)==auxThis.feature.properties.BoroCD})
                    k.updateLineChart(crimeGroupsByDate.all())
                    forceBrush();
                    leafletMap.setView([layer.getBounds().getCenter().lat,layer.getBounds().getCenter().lng],13)
                  }
                })

              }
            });
            geoJson.addTo(leafletMap);
            standardOperation([]);
          }
        }

        var canvas = glLayer.canvas();

        glLayer.canvas.width = canvas.clientWidth;
        glLayer.canvas.height = canvas.clientHeight;


        var gl = canvas.getContext('experimental-webgl', { antialias: true });

        var pixelsToWebGLMatrix = new Float32Array(16);
        var mapMatrix = new Float32Array(16);

        // -- WebGl setup
        var vertexShader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vertexShader, document.getElementById('vshader').text);
        gl.compileShader(vertexShader);

        var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fragmentShader, document.getElementById('fshader').text);
        gl.compileShader(fragmentShader);

        // link shaders to create our program
        var program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);
        gl.useProgram(program);



        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        gl.enable(gl.BLEND);
        // gl.depthFunc(gl.LESS);
        //gl.enable(gl.DEPTH_TEST);
        //gl.disable(gl.DEPTH_TEST)
        // ----------------------------
        // look up the locations for the inputs to our shaders.
        var u_colorFlag = gl.getUniformLocation(program, "u_colorFlag");
        var u_matLoc = gl.getUniformLocation(program, "u_matrix");
        var colorLoc = gl.getAttribLocation(program, "a_color");
        var vertLoc = gl.getAttribLocation(program, "a_vertex");
        gl.aPointSize = gl.getAttribLocation(program, "a_pointSize");
        // Set the matrix to some that makes 1 unit 1 pixel.

        pixelsToWebGLMatrix.set([2 / canvas.width, 0, 0, 0, 0, -2 / canvas.height, 0, 0, 0, 0, 0, 0, -1, 1, 0, 1]);
        gl.viewport(0, 0, canvas.width, canvas.height);

        gl.uniformMatrix4fv(u_matLoc, false, pixelsToWebGLMatrix);
        gl.uniform1i(u_colorFlag, 1);

        var vertArray;
        // -- data
        var crimeTypeCurrVert=[];
        var numPoints=0;
        var indexesByDate =[];
        for(i=0;i<6210;i++)indexesByDate.push([]);
                                //MNT,STI,QES,BRX,BRK
        var indexesForPlaces = [[],[],[],[],[]];
        var indexesForWeekDays = [[],[],[],[],[],[],[]];
        var indexesForCrimeTypes = [];
        var indexesForComDisc = [];
        for(i=0;i<59;i++){
          indexesForComDisc.push([])
        }
        var crimeNYC,crimeByPlace,crimeByPDPT,crimeByDayOfWeek,crimeByComDist,crimeByComDist2;
        d3.csv("NYPD_Complaint_Data_Historic_Sample_From_Node.csv",function(data){
          crimeNYC = crossfilter(data);

          crimeByPlace = crimeNYC.dimension(function(d) { return d.BORO_NM; });
          crimeByPDPT = crimeNYC.dimension(function(d) { return Number(d.ADDR_PCT_CD); });
          crimeByDayOfWeek = crimeNYC.dimension(function(d) { return parseDate(d.CMPLNT_FR_DT).getDay()});
          crimeByComDist = crimeNYC.dimension(function(d) { return d.BORO_CD; });
          crimeByComDist2 = crimeNYC.dimension(function(d) { return d.BORO_CD; });
          hour_dimension = crimeNYC.dimension(function(d) { return d.CMPLNT_FR_TM.split(':')[0];});
          crimeByType = crimeNYC.dimension(function(d) {return d.OFNS_DESC;})
          crimeGroupsByPDPT = crimeByPDPT.group();
          crimeByDate = crimeNYC.dimension(function(d) { return parseDate(d.CMPLNT_FR_DT); });
          crimeByDate2 = crimeNYC.dimension(function(d) { return parseDate(d.CMPLNT_FR_DT); });
          crimeByDate2.filter(function(d){
            return inInterval(parseDate("01/01/2000"),parseDate("12/31/2016"),d)
          })
          // console.log(crimeGroupsByComDist.top(5));
          var hmtable = new HeatMapTable(4,data);
          crimeGroupsByDate = crimeByDate.group(function(d){if(inInterval(parseDate("01/01/2000"),parseDate("12/31/2016"),d))return d});
          crimeGroupsByCrimeType = crimeByType.group();
          crimeGroupsByComDist = crimeByComDist.group();
          for(i=0;i<crimeGroupsByCrimeType.all().length;i++)indexesForCrimeTypes.push([])
          data.forEach(function(d,i){
            //-- 2 coord, 3 rgb colors interleaved buffer
            addMarker(d)
          })
          numPoints=markers.length;
          standardOperation(hashFuncPlace("ALL"));
          k.updateLineChart(crimeGroupsByDate.all());
          bc1.generatePlot(crimeByDayOfWeek)
          bc2.generatePlot(crimeByPlace)
          bc3.generatePlot(crimeByType)
        })

        var markers=[];
        function addMarker(obj){
          if(obj.OFNS_DESC==""||obj.BORO_NM==""||obj.CMPLNT_FR_DT==""||obj.Latitude==""||obj.Longitude=="")return;
          if(Number(obj.BORO_CD)%100>18)return;
          if(!inInterval(parseDate("01/01/2000"),parseDate("12/31/2016"),parseDate(obj.CMPLNT_FR_DT)))return;
          objAux  = LatLongToPixelXY(parseFloat(obj.Latitude),parseFloat(obj.Longitude));
          var circle ={
              x:objAux.x,
              y:objAux.y,
              text:obj.OFNS_DESC,
              area:obj.BORO_NM,
              date:parseDate(obj.CMPLNT_FR_DT),
              com_dist:obj.BORO_CD
          }
          indexesForPlaces[placeToCode(circle.area)].push(markers.length);
          indexesByDate[getHashCode(circle.date)].push(markers.length);
          indexesForWeekDays[circle.date.getDay()].push(markers.length);
          indexesForCrimeTypes[getCrimeCode(circle.text)].push(markers.length)
          indexesForComDisc[getCommunityCode(Number(circle.com_dist))].push(markers.length)
          markers.push(circle);
        }

        var popup = oldL.popup();
        function createPopUp(pos,text) {
          console.log("creating pop up");
          popup
          .setLatLng(pos)
          .setContent(text.toString())
          .openOn(leafletMap);
        }


        leafletMap.on('mousemove', function(e) {
          obj = LatLongToPixelXY(e.latlng.lat,e.latlng.lng)
          if(popup._isOpen){
            obj2 = LatLongToPixelXY(popup._latlng.lat,popup._latlng.lng)
            if(aprxEqual(obj.x,obj.y,obj2.x,obj2.y,0.002))return;
            else leafletMap.closePopup();
          }
          else{
            for(i=0;i<vertArray.length;i+=5){
              if(aprxEqual(vertArray[i],vertArray[i+1],obj.x,obj.y,0.0003)){
                createPopUp(e.latlng,crimeTypeCurrVert[(i/5)])
                break;
              }
            }
          }
        });

        function aprxEqual(x1,y1,x2,y2,range){
          return (x1+range>x2 && x1-range<x2 && y1+range>y2 && y1-range<y2)
        }

        function inInterval(a,b,c){
          return (c-a>=0 && b-c>=0);
        }

        function standardOperation(arr) {
          numPoints=arr.length;
          var vertBuffer = gl.createBuffer();
          newArr=[];
          for(i=0;i<numPoints;i++){
            newArr.push(markers[arr[i]].x,markers[arr[i]].y,255,0,0)
            crimeTypeCurrVert.push(markers[arr[i]].text)
          }
          vertArray = new Float32Array(newArr);
          var fsize = vertArray.BYTES_PER_ELEMENT;

          gl.bindBuffer(gl.ARRAY_BUFFER, vertBuffer);
          gl.bufferData(gl.ARRAY_BUFFER, vertArray, gl.DYNAMIC_DRAW);

          gl.vertexAttribPointer(vertLoc, 2, gl.FLOAT, false,fsize*5,0);
          gl.enableVertexAttribArray(vertLoc);
          // -- offset for color buffer
          gl.vertexAttribPointer(colorLoc, 3, gl.FLOAT, false, fsize*5, fsize*2);
          gl.enableVertexAttribArray(colorLoc);

          glLayer.redraw();
        }

        function paramType(param){
          if(typeof(param) === 'number')return "number";
          else if(param=='STATEN ISLAND' || param=='QUEENS' || param=='MANHATTAN' || param=='BROOKLYN' || param=='BRONX')return "place";
          else return "type"
        }
        function getCrimeCode(param){
          if(param=="ASSAULT 3 & RELATED OFFENSES")return 0
          else if(param=="CRIMINAL MISCHIEF & RELATED OF")return 1
          else if(param=="HARRASSMENT 2")return 2
          else if(param=="PETIT LARCENY")return 3
          else if(param=="FELONY ASSAULT")return 4
          else if(param=="GRAND LARCENY")return 5
          else if(param=="INTOXICATED & IMPAIRED DRIVING")return 6
          else if(param=="ROBBERY")return 7
          else if(param=="MISCELLANEOUS PENAL LAW")return 8
          else if(param=="OFF. AGNST PUB ORD SENSBLTY &")return 9
          else if(param=="BURGLARY")return 10
          else if(param=="DANGEROUS WEAPONS")return 11
          else if(param=="OFFENSES AGAINST PUBLIC ADMINI")return 12
          else if(param=="DANGEROUS DRUGS")return 13
          else if(param=="GRAND LARCENY OF MOTOR VEHICLE")return 14
          else if(param=="SEX CRIMES")return 15
          else if(param=="VEHICLE AND TRAFFIC LAWS")return 16
          else if(param=="RAPE")return 17
          else if(param=="CRIMINAL TRESPASS")return 18
          else if(param=="OTHER OFFENSES RELATED TO THEF")return 19
          else if(param=="FORGERY")return 20
          else if(param=="OFFENSES AGAINST THE PERSON")return 21
          else if(param=="UNAUTHORIZED USE OF A VEHICLE")return 22
          else if(param=="ARSON")return 23
          else if(param=="THEFT-FRAUD")return 24
          else if(param=="POSSESSION OF STOLEN PROPERTY")return 25
          else if(param=="PETIT LARCENY OF MOTOR VEHICLE")return 26
          else if(param=="FRAUDS")return 27
          else if(param=="OFFENSES INVOLVING FRAUD")return 28
          else if(param=="ADMINISTRATIVE CODE")return 29
        }
        function getCommunityCode(param){
          if(param==101)return 0
          else if(param==102)return 1
          else if(param==103)return 2
          else if(param==104)return 3
          else if(param==105)return 4
          else if(param==106)return 5
          else if(param==107)return 6
          else if(param==108)return 7
          else if(param==109)return 8
          else if(param==110)return 9
          else if(param==111)return 10
          else if(param==112)return 11
          else if(param==201)return 12
          else if(param==202)return 13
          else if(param==203)return 14
          else if(param==204)return 15
          else if(param==205)return 16
          else if(param==206)return 17
          else if(param==207)return 18
          else if(param==208)return 19
          else if(param==209)return 20
          else if(param==210)return 21
          else if(param==211)return 22
          else if(param==212)return 23
          else if(param==301)return 24
          else if(param==302)return 25
          else if(param==303)return 26
          else if(param==304)return 27
          else if(param==305)return 28
          else if(param==306)return 29
          else if(param==307)return 30
          else if(param==308)return 31
          else if(param==309)return 32
          else if(param==310)return 33
          else if(param==311)return 34
          else if(param==312)return 35
          else if(param==313)return 36
          else if(param==314)return 37
          else if(param==315)return 38
          else if(param==316)return 39
          else if(param==317)return 40
          else if(param==318)return 41
          else if(param==401)return 42
          else if(param==402)return 43
          else if(param==403)return 44
          else if(param==404)return 45
          else if(param==405)return 46
          else if(param==406)return 47
          else if(param==407)return 48
          else if(param==408)return 49
          else if(param==409)return 50
          else if(param==410)return 51
          else if(param==411)return 52
          else if(param==412)return 53
          else if(param==413)return 54
          else if(param==414)return 55
          else if(param==501)return 56
          else if(param==502)return 57
          else if(param==503)return 58
        }
        function placeToCode(place){
          if(place=="MANHATTAN")return 0;
          if(place=="STATEN ISLAND")return 1;
          if(place=="QUEENS")return 2;
          if(place=="BRONX")return 3;
          if(place=="BROOKLYN")return 4;
          return 5;
        }

        function hashFuncPlace(place){
          if(placeToCode(place)==5)return Array.apply(null, {length: markers.length }).map(Number.call, Number)
          return indexesForPlaces[placeToCode(place)];
        }

        function getHashCode(date){
          return Math.round(((Date.parse(date.toString()))/86400000)-10957)
          //getIndexForDate retorna 0 para 01/01/2000, 1 para 01/02/2000,..., 6209 para 31/12/2016
        }

        function hashFuncDate(firstDate,finalDate){
          return [].concat.apply([], indexesByDate.slice(getHashCode(firstDate), (getHashCode(finalDate)+1)));
        }

        function intersection ( A , B ){
            var m = A.reduce(function(m, v) { m[v] = 1; return m; }, {});
            return B.filter(function(v) { return m[v]; });
        }
        function manyIntersections(arrayOfArrays){
          return arrayOfArrays.reduce(intersection)
        }

        function forceBrush(){
          k.forceBrush();
        }

        function updateByCrimeType(typesArray){
          if(document.getElementById('remGeoButton').checked){
            if(typesArray.length>0)crimeByType.filter(function(d){return typesArray.indexOf(d)>-1;})
            else crimeByType.filterAll()
            k.updateLineChart(crimeGroupsByDate.all())
            removeGeoJson();
            return;
          }
          if(typesArray.length>0){
            crimeByType.filter(function(d){return typesArray.indexOf(d)>-1;})
            k.updateLineChart(crimeGroupsByDate.all())
          }
          else{
            crimeByType.filterAll();
            k.updateLineChart(crimeGroupsByDate.all())
          }
          arrayFilterPlaces=[];
          arrayFilterWeekDays=[];
          arrayFilterTypes=[];
          currentFilters.forEach(function(d){
            ptype = paramType(d);
            if(ptype=="number"){
              arrayFilterWeekDays.push(indexesForWeekDays[d]);
            }
            else if(ptype=="place"){
              arrayFilterPlaces.push(hashFuncPlace(d))
            }
            else arrayFilterTypes.push(indexesForCrimeTypes[getCrimeCode(d)])
          })
          if(arrayFilterWeekDays.length>0)arrayFilterWeekDays = [].concat.apply([], arrayFilterWeekDays.slice(0, arrayFilterWeekDays.length));
          else arrayFilterWeekDays = [].concat.apply([], indexesForWeekDays.slice(0, indexesForWeekDays.length));
          if(arrayFilterPlaces.length>0)arrayFilterPlaces = [].concat.apply([], arrayFilterPlaces.slice(0, arrayFilterPlaces.length))
          else arrayFilterPlaces = [].concat.apply([], indexesForPlaces.slice(0, indexesForPlaces.length))
          if(arrayFilterTypes.length>0)arrayFilterTypes = [].concat.apply([], arrayFilterTypes.slice(0, arrayFilterTypes.length))
          else arrayFilterTypes = [].concat.apply([], indexesForCrimeTypes.slice(0, indexesForCrimeTypes.length))

          var locationFilter;
          if(comDiscFilter.length>0)locationFilter=indexesForComDisc[getCommunityCode(comDiscFilter[0])]
          else locationFilter=[].concat.apply([], indexesForComDisc.slice(0, indexesForComDisc.length));

          standardOperation(manyIntersections([hashFuncDate(limitDate1,limitDate2),arrayFilterPlaces,arrayFilterWeekDays,arrayFilterTypes,locationFilter]))
        }

        function updateByWeekDay(daysArray){
          if(document.getElementById('remGeoButton').checked){
            if(daysArray.length>0)crimeByDayOfWeek.filter(function(d){return daysArray.indexOf(d)>-1;})
            else crimeByDayOfWeek.filterAll()
            k.updateLineChart(crimeGroupsByDate.all())
            removeGeoJson();
            return;
          }
          if(daysArray.length>0){
            crimeByDayOfWeek.filter(function(d){return daysArray.indexOf(d)>-1;})
            k.updateLineChart(crimeGroupsByDate.all())
          }
          else{
            crimeByDayOfWeek.filterAll();
            k.updateLineChart(crimeGroupsByDate.all())
          }
          arrayFilterPlaces=[];
          arrayFilterWeekDays=[];
          arrayFilterTypes=[];
          currentFilters.forEach(function(d){
            ptype = paramType(d);
            if(ptype=="number"){
              arrayFilterWeekDays.push(indexesForWeekDays[d]);
            }
            else if(ptype=="place"){
              arrayFilterPlaces.push(hashFuncPlace(d))
            }
            else arrayFilterTypes.push(indexesForCrimeTypes[getCrimeCode(d)])
          })
          if(arrayFilterWeekDays.length>0)arrayFilterWeekDays = [].concat.apply([], arrayFilterWeekDays.slice(0, arrayFilterWeekDays.length));
          else arrayFilterWeekDays = [].concat.apply([], indexesForWeekDays.slice(0, indexesForWeekDays.length));
          if(arrayFilterPlaces.length>0)arrayFilterPlaces = [].concat.apply([], arrayFilterPlaces.slice(0, arrayFilterPlaces.length))
          else arrayFilterPlaces = [].concat.apply([], indexesForPlaces.slice(0, indexesForPlaces.length))
          if(arrayFilterTypes.length>0)arrayFilterTypes = [].concat.apply([], arrayFilterTypes.slice(0, arrayFilterTypes.length))
          else arrayFilterTypes = [].concat.apply([], indexesForCrimeTypes.slice(0, indexesForCrimeTypes.length))
          var locationFilter;
          if(comDiscFilter.length>0)locationFilter=indexesForComDisc[getCommunityCode(comDiscFilter[0])]
          else locationFilter=[].concat.apply([], indexesForComDisc.slice(0, indexesForComDisc.length));

          standardOperation(manyIntersections([hashFuncDate(limitDate1,limitDate2),arrayFilterPlaces,arrayFilterWeekDays,arrayFilterTypes,locationFilter]))
        }
        function forceSelection(strArray){
          if(document.getElementById('remGeoButton').checked){
            if(strArray.length>0)crimeByPlace.filter(function(d){return strArray.indexOf(d)>-1;})
            else crimeByPlace.filterAll()
            k.updateLineChart(crimeGroupsByDate.all())
            removeGeoJson();
            return;
          }
          if(strArray.length>0){
            crimeByPlace.filter(function(d){return strArray.indexOf(d)>-1;})
            k.updateLineChart(crimeGroupsByDate.all())
          }
          else{
            crimeByPlace.filterAll()
            k.updateLineChart(crimeGroupsByDate.all())
          }
          arrayFilterPlaces=[];
          arrayFilterWeekDays=[];
          arrayFilterTypes=[];
          currentFilters.forEach(function(d){
            ptype = paramType(d);
            if(ptype=="number"){
              arrayFilterWeekDays.push(indexesForWeekDays[d]);
            }
            else if(ptype=="place"){
              arrayFilterPlaces.push(hashFuncPlace(d))
            }
            else arrayFilterTypes.push(indexesForCrimeTypes[getCrimeCode(d)])
          })
          if(arrayFilterWeekDays.length>0)arrayFilterWeekDays = [].concat.apply([], arrayFilterWeekDays.slice(0, arrayFilterWeekDays.length));
          else arrayFilterWeekDays = [].concat.apply([], indexesForWeekDays.slice(0, indexesForWeekDays.length));
          if(arrayFilterPlaces.length>0)arrayFilterPlaces = [].concat.apply([], arrayFilterPlaces.slice(0, arrayFilterPlaces.length))
          else arrayFilterPlaces = [].concat.apply([], indexesForPlaces.slice(0, indexesForPlaces.length))
          if(arrayFilterTypes.length>0)arrayFilterTypes = [].concat.apply([], arrayFilterTypes.slice(0, arrayFilterTypes.length))
          else arrayFilterTypes = [].concat.apply([], indexesForCrimeTypes.slice(0, indexesForCrimeTypes.length))
          var locationFilter;
          if(comDiscFilter.length>0)locationFilter=indexesForComDisc[getCommunityCode(comDiscFilter[0])]
          else locationFilter=[].concat.apply([], indexesForComDisc.slice(0, indexesForComDisc.length));

          standardOperation(manyIntersections([hashFuncDate(limitDate1,limitDate2),arrayFilterPlaces,arrayFilterWeekDays,arrayFilterTypes,locationFilter]))
        }

        function drawingOnCanvas(canvasOverlay, params) {
            if (gl == null) return;

            gl.clear(gl.COLOR_BUFFER_BIT);

            var pointSize = Math.max(leafletMap.getZoom() - 4.0, 1.0);
            gl.vertexAttrib1f(gl.aPointSize, pointSize);


            pixelsToWebGLMatrix.set([2 / canvas.width, 0, 0, 0, 0, -2 / canvas.height, 0, 0, 0, 0, 0, 0, -1, 1, 0, 1]);
            gl.viewport(0, 0, canvas.width, canvas.height);
            // -- set base matrix to translate canvas pixel coordinates -> webgl coordinates
            mapMatrix.set(pixelsToWebGLMatrix);

            var bounds = leafletMap.getBounds();
            var topLeft = new L.LatLng(bounds.getNorth(), bounds.getWest());
            var offset = LatLongToPixelXY(topLeft.lat, topLeft.lng);

            // -- Scale to current zoom
            var scale = Math.pow(2, leafletMap.getZoom());
            scaleMatrix(mapMatrix, scale, scale);

            translateMatrix(mapMatrix, -offset.x, -offset.y);

            // -- attach matrix value to 'mapMatrix' uniform in shader
            gl.uniformMatrix4fv(u_matLoc, false, mapMatrix);

            gl.drawArrays(gl.POINTS, 0, numPoints);
        }
        // Returns a random integer from 0 to range - 1.
        function randomInt(range) {
            return Math.floor(Math.random() * range);
        }

        function LatLongToPixelXY(latitude, longitude) {
            var pi_180 = Math.PI / 180.0;
            var pi_4 = Math.PI * 4;
            var sinLatitude = Math.sin(latitude * pi_180);
            var pixelY = (0.5 - Math.log((1 + sinLatitude) / (1 - sinLatitude)) / (pi_4)) * 256;
            var pixelX = ((longitude + 180) / 360) * 256;

            var pixel = { x: pixelX, y: pixelY };

            return pixel;
        }

        function translateMatrix(matrix, tx, ty) {
            // translation is in last column of matrix
            matrix[12] += matrix[0] * tx + matrix[4] * ty;
            matrix[13] += matrix[1] * tx + matrix[5] * ty;
            matrix[14] += matrix[2] * tx + matrix[6] * ty;
            matrix[15] += matrix[3] * tx + matrix[7] * ty;
        }

        function scaleMatrix(matrix, scaleX, scaleY) {
            // scaling x and y, which is just scaling first two columns of matrix
            matrix[0] *= scaleX;
            matrix[1] *= scaleX;
            matrix[2] *= scaleX;
            matrix[3] *= scaleX;

            matrix[4] *= scaleY;
            matrix[5] *= scaleY;
            matrix[6] *= scaleY;
            matrix[7] *= scaleY;
        }

        /*
        function latlonToPixels(lat, lon) {
            initialResolution = 2 * Math.PI * 6378137 / 256, // at zoomlevel 0
            originShift = 2 * Math.PI * 6378137 / 2;

            // -- to meters
            var mx = lon * originShift / 180;
            var my = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
            my = my * originShift / 180;


            // -- to pixels at zoom level 0

            var res = initialResolution;
            x = (mx + originShift) / res,
            y = (my + originShift) / res;


            return { x: x, y: 256- y };
        }
        */
        // -- converts latlon to pixels at zoom level 0 (for 256x256 tile size) , inverts y coord )
        // -- source : http://build-failed.blogspot.cz/2013/02/displaying-webgl-data-on-google-maps.html


    </script>
    <!--
    <label id="labelMapa0">All</label>
    <label id="labelMapa1">Queens</label>
    <label id="labelMapa2">Bronx</label>
    <label id="labelMapa3">Brooklyn</label>
    <label id="labelMapa4">Staten Island</label>
    <label id="labelMapa5">Manhattan</label>
    -->
    <label id="policeDepts">Show Police Depts.</label>

</body>
</html>
